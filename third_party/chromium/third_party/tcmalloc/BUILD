# Please refer to base/allocator/BUILD.gn for detail

licenses(["notice"])  # BSD 3-Clause

load(
    "//bazel:felicia.bzl",
    "if_windows",
)
load(
    "//third_party/chromium:chromium.bzl",
    "chromium_cc_library",
)
load(
    "//third_party/chromium/third_party/tcmalloc:tcmalloc.bzl",
    "tcmalloc_additional_hdrs",
    "tcmalloc_additional_srcs",
    "tcmalloc_copts",
    "tcmalloc_defines",
    "tcmalloc_dir",
    "tcmalloc_linkopts",
)

package(default_visibility = ["//third_party/chromium:internal"])

chromium_cc_library(
    name = "tcmalloc",
    srcs = ["//third_party/chromium/base:debugallocation_shim_srcs"] + [
        "%s/src/base/abort.cc" % tcmalloc_dir(),
        "%s/src/base/elf_mem_image.cc" % tcmalloc_dir(),
        "%s/src/base/linuxthreads.cc" % tcmalloc_dir(),
        "%s/src/base/logging.cc" % tcmalloc_dir(),
        "%s/src/base/low_level_alloc.cc" % tcmalloc_dir(),
        "%s/src/base/spinlock.cc" % tcmalloc_dir(),
        "%s/src/base/spinlock_internal.cc" % tcmalloc_dir(),
        "%s/src/base/sysinfo.cc" % tcmalloc_dir(),
        "%s/src/base/vdso_support.cc" % tcmalloc_dir(),
        "%s/src/central_freelist.cc" % tcmalloc_dir(),
        "%s/src/common.cc" % tcmalloc_dir(),
        "%s/src/free_list.cc" % tcmalloc_dir(),
        "%s/src/heap-profile-table.cc" % tcmalloc_dir(),
        "%s/src/heap-profiler.cc" % tcmalloc_dir(),
        "%s/src/internal_logging.cc" % tcmalloc_dir(),
        "%s/src/malloc_extension.cc" % tcmalloc_dir(),
        "%s/src/malloc_hook.cc" % tcmalloc_dir(),
        "%s/src/maybe_threads.cc" % tcmalloc_dir(),
        "%s/src/memory_region_map.cc" % tcmalloc_dir(),
        "%s/src/page_heap.cc" % tcmalloc_dir(),
        "%s/src/raw_printer.cc" % tcmalloc_dir(),
        "%s/src/sampler.cc" % tcmalloc_dir(),
        "%s/src/span.cc" % tcmalloc_dir(),
        "%s/src/stack_trace_table.cc" % tcmalloc_dir(),
        "%s/src/stacktrace.cc" % tcmalloc_dir(),
        "%s/src/static_vars.cc" % tcmalloc_dir(),
        "%s/src/symbolize.cc" % tcmalloc_dir(),
        "%s/src/system-alloc.cc" % tcmalloc_dir(),
        "%s/src/base/atomicops-internals-x86.cc" % tcmalloc_dir(),
        "%s/src/thread_cache.cc" % tcmalloc_dir(),
    ] + tcmalloc_additional_srcs() + if_windows([
        "%s/src/windows/port.cc" % tcmalloc_dir(),
    ]),
    hdrs = [
        "%s/src/config.h" % tcmalloc_dir(),
        "%s/src/config_android.h" % tcmalloc_dir(),
        "%s/src/config_linux.h" % tcmalloc_dir(),
        "%s/src/config_win.h" % tcmalloc_dir(),
        "%s/src/base/abort.h" % tcmalloc_dir(),
        "%s/src/base/arm_instruction_set_select.h" % tcmalloc_dir(),
        "%s/src/base/atomicops.h" % tcmalloc_dir(),
        "%s/src/base/commandlineflags.h" % tcmalloc_dir(),
        "%s/src/base/elf_mem_image.h" % tcmalloc_dir(),
        "%s/src/base/linuxthreads.h" % tcmalloc_dir(),
        "%s/src/base/logging.h" % tcmalloc_dir(),
        "%s/src/free_list.h" % tcmalloc_dir(),
        "%s/src/gperftools/heap-profiler.h" % tcmalloc_dir(),
        "%s/src/gperftools/malloc_extension.h" % tcmalloc_dir(),
        "%s/src/gperftools/malloc_hook.h" % tcmalloc_dir(),
        "%s/src/gperftools/stacktrace.h" % tcmalloc_dir(),
        "%s/src/heap-profile-table.h" % tcmalloc_dir(),
        "%s/src/internal_logging.h" % tcmalloc_dir(),
        "%s/src/linked_list.h" % tcmalloc_dir(),
        "%s/src/malloc_hook-inl.h" % tcmalloc_dir(),
        "%s/src/maybe_threads.h" % tcmalloc_dir(),
        "%s/src/memory_region_map.h" % tcmalloc_dir(),
        "%s/src/page_heap.h" % tcmalloc_dir(),
        "%s/src/raw_printer.h" % tcmalloc_dir(),
        "%s/src/sampler.h" % tcmalloc_dir(),
        "%s/src/span.h" % tcmalloc_dir(),
        "%s/src/stack_trace_table.h" % tcmalloc_dir(),
        "%s/src/static_vars.h" % tcmalloc_dir(),
        "%s/src/symbolize.h" % tcmalloc_dir(),
        "%s/src/base/low_level_alloc.h" % tcmalloc_dir(),
        "%s/src/base/spinlock.h" % tcmalloc_dir(),
        "%s/src/base/spinlock_internal.h" % tcmalloc_dir(),
        "%s/src/base/synchronization_profiling.h" % tcmalloc_dir(),
        "%s/src/base/sysinfo.h" % tcmalloc_dir(),
        "%s/src/base/atomicops-internals-arm-generic.h" % tcmalloc_dir(),
        "%s/src/base/atomicops-internals-arm-v6plus.h" % tcmalloc_dir(),
        "%s/src/base/atomicops-internals-linuxppc.h" % tcmalloc_dir(),
        "%s/src/base/atomicops-internals-macosx.h" % tcmalloc_dir(),
        "%s/src/base/atomicops-internals-windows.h" % tcmalloc_dir(),
        "%s/src/base/atomicops-internals-x86.h" % tcmalloc_dir(),
        "%s/src/base/vdso_support.h" % tcmalloc_dir(),
        "%s/src/central_freelist.h" % tcmalloc_dir(),
        "%s/src/common.h" % tcmalloc_dir(),
        "%s/src/thread_cache.h" % tcmalloc_dir(),
    ] + tcmalloc_additional_hdrs() + if_windows([
        "%s/src/windows/port.h" % tcmalloc_dir(),
        # "%s/src/system-alloc.h" % tcmalloc_dir(),
    ]) + [
        # TODO: I'm not sure if it is okay to do that?
        "%s/src/system-alloc.h" % tcmalloc_dir(),
        "%s/src/addressmap-inl.h" % tcmalloc_dir(),
        "%s/src/base/basictypes.h" % tcmalloc_dir(),
        "%s/src/base/dynamic_annotations.h" % tcmalloc_dir(),
        "%s/src/base/googleinit.h" % tcmalloc_dir(),
        "%s/src/base/linux_syscall_support.h" % tcmalloc_dir(),
        "%s/src/base/spinlock_linux-inl.h" % tcmalloc_dir(),
        "%s/src/base/stl_allocator.h" % tcmalloc_dir(),
        "%s/src/base/thread_annotations.h" % tcmalloc_dir(),
        "%s/src/base/thread_lister.h" % tcmalloc_dir(),
        "%s/src/gperftools/malloc_extension_c.h" % tcmalloc_dir(),
        "%s/src/gperftools/malloc_hook_c.h" % tcmalloc_dir(),
        "%s/src/gperftools/tcmalloc.h" % tcmalloc_dir(),
        "%s/src/heap-profile-stats.h" % tcmalloc_dir(),
        "%s/src/libc_override.h" % tcmalloc_dir(),
        "%s/src/malloc_hook_mmap_linux.h" % tcmalloc_dir(),
        "%s/src/packed-cache-inl.h" % tcmalloc_dir(),
        "%s/src/page_heap_allocator.h" % tcmalloc_dir(),
        "%s/src/pagemap.h" % tcmalloc_dir(),
        "%s/src/stacktrace_config.h" % tcmalloc_dir(),
        "%s/src/stacktrace_x86-inl.h" % tcmalloc_dir(),
        "%s/src/tcmalloc_guard.h" % tcmalloc_dir(),

        # Needed by debugallocation_shim.cc
        "%s/src/tcmalloc.h" % tcmalloc_dir(),
        "%s/src/tcmalloc.cc" % tcmalloc_dir(),
        "%s/src/debugallocation.cc" % tcmalloc_dir(),

        # Also needed
        "%s/src/libc_override_glibc.h" % tcmalloc_dir(),
        "%s/src/libc_override_osx.h" % tcmalloc_dir(),
        "%s/src/libc_override_gcc_and_weak.h" % tcmalloc_dir(),
    ],
    copts = tcmalloc_copts(),
    defines = tcmalloc_defines(),
    includes = [
        ".",
        "%s/src/base" % tcmalloc_dir(),
        "%s/src" % tcmalloc_dir(),
    ],
    linkopts = tcmalloc_linkopts(),
    deps = [
        "//third_party/chromium:base_buildflags",
        "//third_party/chromium/base:dynamic_annotations",
    ],
)
