branches:
  only:
  - master

language: cpp
matrix:
  include:
    - os: linux
      dist: xenial
      sudo: required
      services: docker
      install:
        - sudo apt-get install -y python3
      script:
        - docker build . -t felicia -f docker/Dockerfile.ubuntu
        - python3 scripts/felicia.py --with_docker build all --with_test --options "--test_tag_filters -benchmark"
        - python3 scripts/felicia.py --with_docker build all --with_test --options "--test_tag_filters -benchmark -c opt"
    - os: osx
      osx_image: xcode10
      sudo: required
      compiler: clang
      before_install:
        - sudo xcodebuild -license accept
        # TODO(chokobole): When doing just "softwareupdate --install" with label,
        # Command Line Tools (macOS High Sierra version 10.13) for Xcode,
        # says Command Line Tools (macOS High Sierra version 10.13) for Xcode: No such update
        # so did workaround with -r option.
        - softwareupdate --install -r
      install:
        - ./installers/install_bazel.sh
      script:
        - python3 scripts/felicia.py build all --with_test --options "--test_tag_filters -benchmark"
        - bazel clean
        - python3 scripts/felicia.py build all --with_test --options "--test_tag_filters -benchmark -c opt"
notifications:
    email:
        on_success: always
        on_failure: always